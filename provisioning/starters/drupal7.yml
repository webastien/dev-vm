- name:    Install an instance of Drupal 7 for {{ site.domain }}
  include: tasks/sites/drupal-instance.yml version=7

- name:     Check the site language defined in config
  set_fact: site_lang="{{ drush_si_args | regex_search('--locale=(.*?)((\s+--[a-z\-]+=.*)|$)', '\\1')  }}"
- set_fact: site_lang="{{ site_lang[0] if site_lang[0] is defined else '' }}"

- name:  Install Localization update for {{ site.domain }}
  shell: drush -y pm-enable l10n_update chdir="{{ ansible_env.HOME }}/www/{{ site.domain }}"
  when:  site_lang != '' and tasks['php']['config']['drushLanguage'] is defined and tasks['php']['config']['drushLanguage']

- name:  Activate language {{ site_lang }} for {{ site.domain }}
  shell: drush -y langadd {{ site_lang }} && drush -y langdef {{ site_lang }} chdir="{{ ansible_env.HOME }}/www/{{ site.domain }}"
  when:  site_lang != '' and tasks['php']['config']['drushLanguage'] is defined and tasks['php']['config']['drushLanguage']

- name:  Update {{ site_lang }} translations for {{ site.domain }}
  shell: drush -y l10n-update-refresh && drush -y l10n-update chdir="{{ ansible_env.HOME }}/www/{{ site.domain }}"
  when:  site_lang != '' and tasks['php']['config']['drushLanguage'] is defined and tasks['php']['config']['drushLanguage']

